buildscript {
    repositories {
        maven { url "https://maven.aliyun.com/repository/public" }
        maven { url "https://maven.fabricmc.net/" }
        mavenCentral()
    }
    dependencies {
        classpath "net.fabricmc:fabric-loom:1.3.9"
    }
}

plugins {
    id 'java'
}

apply plugin: 'fabric-loom'

version = project.mod_version
group = project.maven_group
archivesBaseName = project.archives_base_name

sourceSets {
    main {
        java {
            srcDirs = ['src/main/java', 'src/client/java']
        }
        resources {
            srcDirs = ['src/main/resources']
        }
    }
}

repositories {
    maven { url "https://maven.aliyun.com/repository/public" }
    maven { url "https://maven.fabricmc.net/" }
    mavenCentral()
}

loom {
    mixin {
        defaultRefmapName = "${project.archives_base_name}.refmap.json"
    }
}

dependencies {
    minecraft "com.mojang:minecraft:1.20.1"
    mappings loom.officialMojangMappings()
    modImplementation "net.fabricmc:fabric-loader:0.14.22"
    modImplementation "net.fabricmc.fabric-api:fabric-api:0.87.0+1.20.1"
}

processResources {
    inputs.property "version", project.version
    filesMatching("fabric.mod.json") {
        expand "version": project.version
    }
}

tasks.withType(JavaCompile).configureEach {
    options.encoding = "UTF-8"
    options.release = 17
}

jar {
    from("LICENSE") {
        rename { "${it}_${project.base.archivesName.get()}"}
    }
}

remapJar {
    doLast {
        def outputJar = archiveFile.get().asFile
        println "å®˜æ–¹æ˜ å°„ç»“æœ: ${outputJar.name}"
        println "å¤§å°: ${outputJar.length()} bytes"
        
        if (outputJar.length() > 10240) {
            def targetFile = new File("${System.getProperty('user.home')}/storage/downloads/${project.archives_base_name}-${project.version}.jar")
            ant.copy(file: outputJar, tofile: targetFile)
            println "âœ… å®˜æ–¹æ˜ å°„æˆåŠŸ! å·²ä¿å­˜: ${targetFile.absolutePath}"
        } else {
            println "âŒ å®˜æ–¹æ˜ å°„ä¹Ÿå¤±è´¥äº†"
        }
    }
}

task buildWithOfficial {
    dependsOn clean, remapJar
}buildscript {
    repositories {
        maven { url "https://maven.aliyun.com/repository/public" }
        maven { url "https://maven.aliyun.com/repository/gradle-plugin" }
        maven { url "https://maven.fabricmc.net/" }
        maven { url "https://mirrors.cloud.tencent.com/nexus/repository/maven-public/" }
        mavenCentral()
    }
    dependencies {
        classpath "net.fabricmc:fabric-loom:1.3.9"
    }
}

plugins {
    id 'java'
    id 'maven-publish'
}

apply plugin: 'fabric-loom'

version = project.mod_version
group = project.maven_group
archivesBaseName = project.archives_base_name

sourceCompatibility = JavaVersion.VERSION_17
targetCompatibility = JavaVersion.VERSION_17

sourceSets {
    main {
        java {
            srcDirs = ['src/main/java', 'src/client/java']
        }
        resources {
            srcDirs = ['src/main/resources', 'src/client/resources']
        }
    }
}

repositories {
    maven { url "https://maven.aliyun.com/repository/public" }
    maven { url "https://maven.aliyun.com/repository/gradle-plugin" }
    maven { url "https://maven.fabricmc.net/" }
    maven { url "https://mirrors.cloud.tencent.com/nexus/repository/maven-public/" }
    maven { url "https://repo.maven.apache.org/maven2" }
    maven { url "https://libraries.minecraft.net" }
    maven { url "https://jitpack.io" }
    mavenCentral()
}

configurations {
    developmentRuntime
}

loom {
    mixin {
        defaultRefmapName = "${project.archives_base_name}.refmap.json"
        useLegacyMixinAp = false
    }
    
    runs {
        client {
            client()
            configName = "Fabric Client"
            ideConfigGenerated(true)
            runDir("run/client")
            source(sourceSets.main)
        }
        
        server {
            server()
            configName = "Fabric Server"
            ideConfigGenerated(true)
            runDir("run/server")
            source(sourceSets.main)
        }
    }
    
    // ä¼˜åŒ–è®¾ç½®
    interfaceInjection {
        enableDependencyInterfaceInjection = true
    }
    
    // è§£å†³Termuxç¯å¢ƒé—®é¢˜
    setAutoTargetSources(false)
}

dependencies {
    minecraft "com.mojang:minecraft:1.20.1"
    mappings loom.officialMojangMappings()
    modImplementation "net.fabricmc:fabric-loader:0.14.22"
    
    // Fabric API
    modImplementation "net.fabricmc.fabric-api:fabric-api:0.87.0+1.20.1"
    
    // å¼€å‘æ—¶ä¾èµ–
    developmentRuntime "net.fabricmc:fabric-loader:0.14.22"
    
    // æµ‹è¯•ä¾èµ–
    testImplementation "org.junit.jupiter:junit-jupiter:5.9.2"
    testImplementation "org.mockito:mockito-core:5.3.1"
}

processResources {
    inputs.property "version", project.version
    inputs.property "minecraft_version", "1.20.1"
    inputs.property "loader_version", "0.14.22"
    
    filesMatching("fabric.mod.json") {
        expand(
            "version": project.version,
            "minecraft_version": "1.20.1",
            "loader_version": "0.14.22"
        )
    }    
    // æ’é™¤å¼€å‘æ–‡ä»¶
    exclude("**/*.psd")
    exclude("**/*.bbmodel")
}

tasks.withType(JavaCompile).configureEach {
    options.encoding = "UTF-8"
    options.release = 17
    options.compilerArgs += ["-Xmaxerrs", "1000"]
}

tasks.withType(Test).configureEach {
    useJUnitPlatform()
    testLogging {
        events "passed", "skipped", "failed"
        exceptionFormat "full"
    }
}

jar {
    from("LICENSE") {
        rename { "${it}_${project.base.archivesName.get()}"}
    }
    
    manifest {
        attributes(
            'Implementation-Title': project.archives_base_name,
            'Implementation-Version': project.version,
            'Built-By': System.getProperty('user.name'),
            'Built-JDK': System.getProperty('java.version'),
            'Built-On': new Date().format("yyyy-MM-dd'T'HH:mm:ssZ")
        )
    }
    
    doLast {
        def devJar = archiveFile.get().asFile
        println "å¼€å‘ç‰ˆJAR: ${devJar.name}"
        println "å¤§å°: ${devJar.length()} bytes"
        
        if (devJar.length() > 10000) {
            def backupDir = new File("${project.projectDir}/build_success_backup")
            backupDir.mkdirs()
            def randomSuffix = Long.toHexString(System.currentTimeMillis()).substring(8)
            def backupFile = new File(backupDir, "${project.archives_base_name}-${project.version}-${randomSuffix}-dev.jar")
            ant.copy(file: devJar, tofile: backupFile)
            println "âœ… å¼€å‘ç‰ˆå¤‡ä»½: ${backupFile.name}"
        }
    }
    
    // ä¿ç•™å¼€å‘ç‰ˆJAR
    preserve {
        exclude '**/temp/**'
    }
}

remapJar {
    doLast {
        def outputJar = archiveFile.get().asFile
        println "å®˜æ–¹æ˜ å°„ç»“æœ: ${outputJar.name}"
        println "å¤§å°: ${outputJar.length()} bytes"
        
        if (outputJar.length() > 10240) {
            def backupDir = new File("${project.projectDir}/build_success_backup")
            backupDir.mkdirs()
            def randomSuffix = Long.toHexString(System.currentTimeMillis()).substring(8)
            def backupFile = new File(backupDir, "${project.archives_base_name}-${project.version}-${randomSuffix}.jar")
            ant.copy(file: outputJar, tofile: backupFile)
            
            def downloadDir = new File("${System.getProperty('user.home')}/storage/downloads")
            if (downloadDir.exists()) {
                def downloadFile = new File(downloadDir, "${project.archives_base_name}-${project.version}-${randomSuffix}.jar")
                ant.copy(file: outputJar, tofile: downloadFile)
                println "âœ… å®˜æ–¹æ˜ å°„æˆåŠŸ! å·²ä¿å­˜åˆ°ä¸‹è½½ç›®å½•: ${downloadFile.name}"
            } else {
                println "âœ… å®˜æ–¹æ˜ å°„æˆåŠŸ! å·²å¤‡ä»½: ${backupFile.name}"
            }
        } else {
            println "âŒ å®˜æ–¹æ˜ å°„å¤±è´¥: æ–‡ä»¶å¤§å°å¼‚å¸¸"
        }
    }
}

// è‡ªå®šä¹‰æ„å»ºä»»åŠ¡
task buildAndBackup {
    group = 'build'
    description = 'æ„å»ºå¹¶è‡ªåŠ¨å¤‡ä»½åˆ°ä¸‹è½½ç›®å½•'
    
    doFirst {
        println "å¼€å§‹æ„å»º ${project.archives_base_name}-${project.version}"
        println "Javaç‰ˆæœ¬: ${JavaVersion.current()}"
    }
    
    doLast {
        def jarFiles = fileTree(dir: 'build/libs', include: '*.jar')
        jarFiles.each { jarFile ->
            if (jarFile.length() > 10000 && !jarFile.name.contains('sources') && !jarFile.name.contains('javadoc')) {
                def downloadDir = new File("${System.getProperty('user.home')}/storage/downloads")
                if (downloadDir.exists()) {
                    def randomSuffix = Long.toHexString(System.currentTimeMillis()).substring(8)
                    def targetFile = new File(downloadDir, "${project.archives_base_name}-${project.version}-${randomSuffix}.jar")
                    ant.copy(file: jarFile, tofile: targetFile)
                    println "âœ… è‡ªåŠ¨å¤‡ä»½: ${targetFile.name}"
                }
            }
        }
    }
}
buildAndBackup.dependsOn remapJar

task buildWithOfficial {
    group = 'build'
    description = 'ä½¿ç”¨å®˜æ–¹æ˜ å°„æ„å»º'
    dependsOn clean, remapJar
}

// å¿«é€Ÿå¼€å‘æ„å»ºï¼ˆä¸é‡æ˜ å°„ï¼‰
task buildDev {
    group = 'build'
    description = 'å¿«é€Ÿå¼€å‘æ„å»ºï¼ˆä¸é‡æ˜ å°„ï¼‰'
    dependsOn clean, build
    
    doLast {
        def devJar = fileTree(dir: 'build/libs', include: '*dev.jar').singleFile
        if (devJar.exists() && devJar.length() > 10000) {
            def downloadDir = new File("${System.getProperty('user.home')}/storage/downloads")
            if (downloadDir.exists()) {
                def targetFile = new File(downloadDir, "${project.archives_base_name}-${project.version}-DEV.jar")
                ant.copy(file: devJar, tofile: targetFile)
                println "âœ… å¼€å‘ç‰ˆå·²å¤åˆ¶: ${targetFile.name}"
            }
        }
    }
}

// æ„å»ºéªŒè¯ä»»åŠ¡
task verifyBuild {
    group = 'verification'
    description = 'éªŒè¯æ„å»ºç»“æœ'
    
    doLast {
        def jarFiles = fileTree(dir: 'build/libs', include: '*.jar')
        if (jarFiles.isEmpty()) {
            println "âŒ æœªæ‰¾åˆ°ä»»ä½•JARæ–‡ä»¶"
            return
        }
        
        jarFiles.each { jarFile ->
            println "éªŒè¯: ${jarFile.name} (${jarFile.length()} bytes)"
            
            if (jarFile.length() < 5000) {
                println "   âŒ æ–‡ä»¶å¤§å°å¼‚å¸¸"
                return
            }
            
            try {
                def zipFile = new java.util.zip.ZipFile(jarFile)
                def entries = zipFile.entries()
                def fileCount = 0
                def hasFabricMod = false
                def hasMixins = false
                def hasClasses = false
                
                while (entries.hasMoreElements()) {
                    def entry = entries.nextElement()
                    if (!entry.isDirectory()) {
                        fileCount++
                        if (entry.name == "fabric.mod.json") hasFabricMod = true
                        if (entry.name.endsWith(".class")) hasClasses = true
                        if (entry.name.contains("mixins.json")) hasMixins = true
                    }
                }
                zipFile.close()
                
                println "   ğŸ“ åŒ…å« ${fileCount} ä¸ªæ–‡ä»¶"
                if (hasFabricMod) println "   âœ… fabric.mod.json"
                if (hasClasses) println "   âœ… .class æ–‡ä»¶"
                if (hasMixins) println "   âœ… mixin é…ç½®"
                
            } catch (Exception e) {
                println "   âŒ æ— æ³•è¯»å–JARæ–‡ä»¶: ${e.message}"
            }
        }
    }
}

verifyBuild.dependsOn build

// æ¸…ç†ä»»åŠ¡æ‰©å±•
task deepClean {
    group = 'build'
    description = 'æ·±åº¦æ¸…ç†æ„å»ºæ–‡ä»¶'
    
    doLast {
        delete(
            "${project.projectDir}/build_success_backup",
            "${project.projectDir}/run",
            "${project.projectDir}/.gradle",
            "${project.projectDir}/out"
        )
        println "âœ… æ·±åº¦æ¸…ç†å®Œæˆ"
    }
}

clean.dependsOn deepClean

// å‘å¸ƒé…ç½®
publishing {
    publications {
        mavenJava(MavenPublication) {
            from components.java
            artifactId = project.archives_base_name
            version = project.version
            
            pom {
                name = project.archives_base_name
                description = 'A Fabric mod for Minecraft 1.20.1'
                url = 'https://github.com/example/endless_items'
            }
        }
    }    
    repositories {
        maven {
            name = 'local'
            url = "${project.projectDir}/build/repo"
        }
    }
}
